.content.span12.columns
  %fieldset
    %legend
      Choose a profile & date range
    = form_tag :controller => "ga", :action => "report" do 
      .form-stacked
        .span6.columns{style: "margin: 10px"}
          = label :profile, "select:"
          = select :profile, :profile_id, @profiles.collect {|k, v| [truncate(v, length: 40), k]},  {:include_blank => true, :selected => @stuff[:profile_id]}

        .block_1{style: "background-color: lime; margin: 10px; padding: 10px;"}
          = label :profile, "start date:"
          = date_select :profile, :start_date, {:default => @start_date}
          %br
          %br
          = label :profile, "end date:"
          = date_select :profile, :end_date , {:default => @end_date }  
        .block_2{:style => "padding: 10px;"}
      
          .span4.columns.pull-left
            = label :profile, "dimensions:"
            = select(:profile, :dimensions, grouped_options_for_select(dimensions_list, @stuff[:dimensions]), {},{:multiple => true, :size => 10})
        
          .span4.columns.pull-left
            = label :profile, "metrics:"
            = select(:profile, :metrics, grouped_options_for_select(metrics_list, @stuff[:metrics]), {},{:multiple => true, :size => 10})
            %br
            
          .span4.columns.pull-left
            = label :profile, "limit:" 
            = select :profile, :limit, %w[10 25 50 100 500 1000], { :index => nil, :selected => @stuff[:limit]}
            %br

            = label :profile, "offset:"
            = select :profile, :offset, %w[1 10 25 50 100 500 1000], { :index => nil, :selected => @stuff[:offset]}
            %br

            = label :profile, "sort:"
            = select :profile, :sort, %w[asc desc], { :index => nil, :selected => @stuff[:sort]}
            %br

          .button{:style => "clear:both; float: right, margin-top: 20px"}
            = submit_tag "Submit" 
      
  %fieldset
    .results
      - if @results 
        %table.span10.columns
          %tr
            %th
              listing data
            %th
              referral path
            %th
              page views
            %th
              medium
            %th
              unique page views
          - for result in @results
            %tr
              %td
                = truncate(result.second_page_path)
              %td
                = result.referral_path
              %td
                = result.pageviews
              %td
                = result.medium
              %td
                = result.unique_pageviews
        %br

  #chart_bar
  #chart_pie
  %script{:type => 'text/javascript'}

    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});
    google.setOnLoadCallback(drawChart);

    function drawChart() {

    var listing_views = [
    - for result in @results
      - unless result.second_page_path == '/' || result.second_page_path == '(not set)'
        - listing_id = result.second_page_path
        - listing_id.slice!(0)
        = "['#{listing_id}' , #{result.pageviews}],"
    ];

    // Create the data table for Site Visits.
    var title = 'Views by Listing ID';
    var data_site_visits = new google.visualization.DataTable();
    data_site_visits.addColumn('string', 'Listing');
    data_site_visits.addColumn('number', 'Views');
    data_site_visits.addRows( listing_views );

    // Set chart options
    var options = {'title': title, 'width':400, 'height':300 };

    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.BarChart(document.getElementById('chart_bar'));
    var chart2 = new google.visualization.PieChart(document.getElementById('chart_pie'));
    chart.draw(data_site_visits, options);
    chart2.draw(data_site_visits, options);

    google.visualization.events.addListener(chart2, 'select', function() {
    var selection = chart2.getSelection();
    var message = '';
    for (var i = 0; i < selection.length; i++) {
    var item = selection[i];
    if (item.row != null && item.column != null) {
    var str = data_site_visits.getFormattedValue(item.row, item.column);
    message += '{row:' + item.row + ',column:' + item.column + '} = ' + str + '\n';
    } else if (item.row != null) {
    var str = data_site_visits.getFormattedValue(item.row, 0);
    message += '{row:' + item.row + ', column:none}; value (col 0) = ' + str + '\n';
    } else if (item.column != null) {
    var str = data_site_visits.getFormattedValue(0, item.column);
    message += '{row:none, column:' + item.column + '}; value (row 0) = ' + str + '\n';
    }
    }
    if (message == '') {
    message = 'nothing';
    }
    console.log( 'You selected ' + message );
    });
    }
-#= debug @stuff
-#- if defined? @results.fields
-#  = debug @results.fields
-#= debug @results.first
